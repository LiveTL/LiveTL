name: E2E Tests
on: push
jobs:
  e2e-test:
    runs-on: self-hosted
    env:
      DISPLAY: ":0"
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: 'recursive'
    - name: Set up Python 3.8
      uses: actions/setup-python@v2
      with:
        python-version: 3.8
    - name: Set up Node 16
      uses: actions/setup-node@v2
      with:
        node-version: 16
    - name: Fix the broken install
      run: sudo apt --fix-broken install
    - name: Set up Virtual Display for Chrome
      run: |
        sudo /usr/bin/Xvfb $DISPLAY -screen 0 1280x1024x24 &
    - name: Set up Firefox
      run: sudo apt install -y firefox
    - name: Set up Chrome
      run: |
        wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo dpkg -i ./google-chrome-stable_current_amd64.deb
    - name: Install Dependencies
      run: python3 -m pip install -r requirements.txt
    - uses: c-hive/gha-yarn-cache@v1
    - name: Install modules
      run: |
        yarn
    - name: Build extension
      run: yarn e2e:build
    - name: Run tests
      run: DISCORD_REPORT_HOOK=${{ secrets.DISCORD_WEBHOOK }} pytest --tests-per-worker 3 e2e
